<!DOCTYPE html>
<html>
<head>
  <title>Spotify Web Playback SDK Quick Start Tutorial</title>
</head>
<body>
  <h1>Spotify Web Playback SDK Quick Start Tutorial</h1>
  <h2>Open your console log: <code>View > Developer > JavaScript Console</code></h2>

  <!-- Load the Spotify Web Playback SDK -->
<script src="https://sdk.scdn.co/spotify-player.js"></script>

<script>
    fetch('./secretThings.json').then(response=> {
        return response.json().then((data) => {
            secrets=data
            // Called when the Spotify Web Playback SDK is ready to use
            window.onSpotifyWebPlaybackSDKReady = () => {

                // Define the Spotify Connect device, getOAuthToken has an actual token 
                // hardcoded for the sake of simplicity
                var player = new Spotify.Player({
                name: 'A Spotify Web SDK Player',
                getOAuthToken: callback => {
                    callback(secrets.spotifyAPI);
                },
                volume: .1
                });

                // Called when connected to the player created beforehand successfully
                player.addListener('ready', ({ device_id }) => {
                    console.log('Ready with Device ID', device_id);
                    player.id=device_id

                const play = ({
                        spotify_uri,
                        playerInstance: {
                            _options: {
                                getOAuthToken,
                                id
                            }
                        }
                    }) => {
                        getOAuthToken(access_token => {
                            fetch(`https://api.spotify.com/v1/me/player/play?device_id=${player.id}`, {
                                method: 'PUT',
                                body: JSON.stringify({ uris: [spotify_uri] }),
                                headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${access_token}`
                                },
                            });
                        });
                    };

                    play({
                        playerInstance: player,
                        spotify_uri: 'spotify:track:7kW8KlDA7A2Fie3IY299FX',
                    });
                });

                // Connect to the player created beforehand, this is equivalent to 
                // creating a new device which will be visible for Spotify Connect
                player.connect();
            };
        })
    })

</script>
  <button onclick="play">Play</button>
</body>
</html>